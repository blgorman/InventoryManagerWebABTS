{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "5098199611209937554"
    }
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "rg-inventorymgrweb",
      "metadata": {
        "description": "Name of the resource group to create"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "centralus",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "sqlServerName": {
      "type": "string",
      "metadata": {
        "description": "SQL Server name"
      }
    },
    "adminUser": {
      "type": "string",
      "defaultValue": "sqladmin",
      "metadata": {
        "description": "SQL Server admin username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server admin password"
      }
    },
    "sqlDbName": {
      "type": "string",
      "defaultValue": "invmgrdb",
      "metadata": {
        "description": "SQL Database name"
      }
    },
    "databaseSku": {
      "type": "string",
      "defaultValue": "basic",
      "metadata": {
        "description": "SQL Database SKU"
      }
    },
    "appServicePlanName": {
      "type": "string",
      "metadata": {
        "description": "App Service Plan name"
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "P0V3",
      "metadata": {
        "description": "App Service Plan SKU"
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "inventorymanagerweb",
      "metadata": {
        "description": "App Service name"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlServerDeployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "sqlServerName": {
            "value": "[parameters('sqlServerName')]"
          },
          "adminUser": {
            "value": "[parameters('adminUser')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "894628693145798643"
            }
          },
          "parameters": {
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              }
            },
            "adminUser": {
              "type": "string",
              "metadata": {
                "description": "SQL Server admin username"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Server admin password"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the SQL Server"
              }
            }
          },
          "variables": {
            "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
            "sqlServerNameUnique": "[format('{0}-{1}', parameters('sqlServerName'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-05-01-preview",
              "name": "[variables('sqlServerNameUnique')]",
              "location": "[parameters('location')]",
              "properties": {
                "administratorLogin": "[parameters('adminUser')]",
                "administratorLoginPassword": "[parameters('adminPassword')]",
                "version": "12.0",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerNameUnique'), 'AllowAzureServices')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerNameUnique'))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerNameUnique')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlDatabaseDeployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "databaseSku": {
            "value": "[parameters('databaseSku')]"
          },
          "sqlServerName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sqlServerDeployment'), '2022-09-01').outputs.sqlServerName.value]"
          },
          "sqlDbName": {
            "value": "[parameters('sqlDbName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6836017598529799224"
            }
          },
          "parameters": {
            "databaseSku": {
              "type": "string",
              "defaultValue": "basic",
              "metadata": {
                "description": "Database SKU"
              }
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name (from SQL Server module output)"
              }
            },
            "sqlDbName": {
              "type": "string",
              "metadata": {
                "description": "SQL Database name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the SQL Database"
              }
            }
          },
          "variables": {
            "skuMapping": {
              "basic": {
                "name": "Basic",
                "tier": "Basic",
                "capacity": 5
              },
              "standard": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": 10
              },
              "premium": {
                "name": "Premium",
                "tier": "Premium",
                "capacity": 125
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDbName'))]",
              "location": "[parameters('location')]",
              "sku": "[variables('skuMapping')[parameters('databaseSku')]]",
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 2147483648
              }
            }
          ],
          "outputs": {
            "sqlDatabaseName": {
              "type": "string",
              "value": "[parameters('sqlDbName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appServicePlanDeployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanName": {
            "value": "[parameters('appServicePlanName')]"
          },
          "sku": {
            "value": "[parameters('sku')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8395716820805510669"
            }
          },
          "parameters": {
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "P0V3",
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the App Service Plan"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "properties": {
                "reserved": true
              },
              "sku": {
                "name": "[parameters('sku')]"
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appServiceDeployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "appServicePlanId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12561953035467124847"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "defaultValue": "inventorymanagerweb",
              "metadata": {
                "description": "App Service name"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the App Service"
              }
            }
          },
          "variables": {
            "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
            "appServiceNameUnique": "[format('{0}-{1}', parameters('appName'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServiceNameUnique')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOCKER|nginx:latest",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "httpLoggingEnabled": true,
                  "logsDirectorySizeLimit": 35,
                  "detailedErrorLoggingEnabled": true,
                  "requestTracingEnabled": true,
                  "remoteDebuggingEnabled": false
                }
              }
            },
            {
              "type": "Microsoft.Web/sites/slots",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('appServiceNameUnique'), 'staging')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOCKER|nginx:latest",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "httpLoggingEnabled": true,
                  "logsDirectorySizeLimit": 35,
                  "detailedErrorLoggingEnabled": true,
                  "requestTracingEnabled": true,
                  "remoteDebuggingEnabled": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceNameUnique'))]"
              ]
            }
          ],
          "outputs": {
            "webAppName": {
              "type": "string",
              "value": "[variables('appServiceNameUnique')]"
            },
            "webAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('appServiceNameUnique')), '2023-01-01').defaultHostName)]"
            },
            "stagingSlotName": {
              "type": "string",
              "value": "staging"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appServiceConfigDeployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "sqlServerName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sqlServerDeployment'), '2022-09-01').outputs.sqlServerName.value]"
          },
          "sqlServerAdmin": {
            "value": "[parameters('adminUser')]"
          },
          "sqlServerPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "sqlDbName": {
            "value": "[parameters('sqlDbName')]"
          },
          "webAppName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServiceDeployment'), '2022-09-01').outputs.webAppName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14785666688615444422"
            }
          },
          "parameters": {
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              }
            },
            "sqlServerAdmin": {
              "type": "string",
              "metadata": {
                "description": "SQL Server admin username"
              }
            },
            "sqlServerPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Server admin password"
              }
            },
            "sqlDbName": {
              "type": "string",
              "metadata": {
                "description": "SQL Database name"
              }
            },
            "webAppName": {
              "type": "string",
              "metadata": {
                "description": "Web App name"
              }
            }
          },
          "variables": {
            "connectionString": "[format('Server=tcp:{0}.{1},1433;Initial Catalog={2};User ID={3};Password={4};Encrypt=True;TrustServerCertificate=True;Connection Timeout=30;', parameters('sqlServerName'), environment().suffixes.sqlServerHostname, parameters('sqlDbName'), parameters('sqlServerAdmin'), parameters('sqlServerPassword'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('webAppName'), 'appsettings')]",
              "properties": {
                "ConnectionStrings__InventoryManagerIdentityDB": "[variables('connectionString')]",
                "ConnectionStrings__InventoryDbConnection": "[variables('connectionString')]",
                "ASPNETCORE_ENVIRONMENT": "Production"
              }
            },
            {
              "type": "Microsoft.Web/sites/slots/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('webAppName'), 'staging', 'appsettings')]",
              "properties": {
                "ConnectionStrings__InventoryManagerIdentityDB": "[variables('connectionString')]",
                "ConnectionStrings__InventoryDbConnection": "[variables('connectionString')]",
                "ASPNETCORE_ENVIRONMENT": "Staging"
              }
            }
          ],
          "outputs": {
            "productionConnectionString": {
              "type": "string",
              "value": "[variables('connectionString')]"
            },
            "stagingConnectionString": {
              "type": "string",
              "value": "[variables('connectionString')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServiceDeployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[parameters('resourceGroupName')]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sqlServerDeployment'), '2022-09-01').outputs.sqlServerName.value]"
    },
    "webAppName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServiceDeployment'), '2022-09-01').outputs.webAppName.value]"
    },
    "webAppUrl": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appServiceDeployment'), '2022-09-01').outputs.webAppUrl.value]"
    }
  }
}